<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>降水落区图绘制</title>
    <meta charset="utf-8">
    <style>
        body{
            text-align: center;
            height: 100%;
            font-family: Microsoft YaHei;
            background: #f7f6f6;
            overflow: auto;
        }
        #mainDiv{
            width: 1024px;
            height: 100%;
            background: rgba(245,245,245,1);
            margin: 0 auto;
            padding: 0 50px;
            font-size: 13px;
            line-height: 18px;
            box-sizing: content-box;
        }

        .leftTable{
            float:left;
        }

        #divAlert{
            padding: 10px 0px 0px 0px;
            text-align:left;
            color: #ff0000;
        }

        .rightTable{
            float:left;
            width: 100%;
            position: relative;
            margin-top: 60px;
            margin-bottom: 60px;
            height: 800px;
            border: 1px solid rgba(80,80,80,0.2);
            display: none;
        }
        .rightTable table {
            width: 100%;
            font-size: 14px;
        }
        .rightTable table tr:nth-child(even){
            background: rgba(255,255,255,1);
        }
        .rightTable table tr:hover{
            background: rgba(217,232,241,1);
        }
        .rightTable table thead tr{
            background: rgba(220,220,220,1);
            color: rgba(45,45,45,1);
            height: 30px;
            font-weight: 400;
        }
        .rightTable table td{
            padding: 2px;
            height: 22px;
        }
        .rightTable table td input{
            padding: 0;
            width: 35px;
            height: 14px;
            text-align: center;
            margin: 1px 0 -2px 0;
        }
        .delStation{
            cursor: pointer;
        }
        .btn_run{
            float:left;
            cursor:pointer;
            min-width: 100px;
            height: 32px;
            margin-left: 8px;
            line-height: 32px;
            font-size: 16px;
            color: #ffffff;
            background-color: rgb(48,202,254);
            border-radius: 6px;
            border: 1px solid #21A9E5;
        }
        table th{
            text-align: center;
        }
        #btn_run:hover,#btn_runFromTable:hover,#btn_setLegend:hover,#btn_creatRainWord:hover{
            background-color: rgb(3,127,223);
        }
        #btn_run:active,#btn_runFromTable:active,#btn_setLegend:active,#btn_creatRainWord:active{
            border: 1px solid #fff;
        }
        #btn_setLegend.active{
            background-color: rgb(3,127,223);
        }
        #setLegendDiv{
            height: 100px;
            width: 100%;
            background-color: rgba(48,202,254,0.2);
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }
        .legentColor{
            border:1px solid #fff;
            border-radius: 4px;
            float: left;
        }
        .legentColor:hover{
            border:1px solid #f00;
            cursor: pointer;
        }
        .legentColor input{
            position: relative;
            width: 40px;
            text-align: center;
        }
        #btn_submit{
            position: absolute;
            top: 40px;
            right: -40px;
            width: 60px;
            height: 28px;
            line-height: 28px;
            font-size: 14px;
            color: #ffffff;
            background-color: rgb(66,196,240);
            border-radius: 6px;
            border: 1px solid #21A9E5;
        }
        #btn_submit:hover{
            cursor:pointer;
            background-color: rgb(3,127,223);
        }
    </style>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/colpick.css">
    <link rel="stylesheet" href="css/common.css"/>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/bootstrap-modal.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/colpick.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>

    <script type="text/javascript">
        var locationUrl = window.document.location.href;
        var tableJsonData = [];
        var points = [];
        var userAreaName = "";//区域名称
        var userDepartCode = "";//部门编号
        var userDepartName = "";//部门名称
        var productName = "";//产品名称
        $(function(){
			init();
			function init(){
                var dtEnd = new Date();
                dtEnd.setHours(8, 0, 0, 0);
                var dtStart = addHour(dtEnd, -24);
                $("#dateStart").val(formatDate(dtStart, false, true));
                $("#dateEnd").val(formatDate(dtEnd, false, true));
                $(".logo").click(function(){
                    window.location.href="nativ.html";
                });

                $("#login").find("a").click(function(){
                    if(this.id == "a_exit"){
                        window.location.href="index.html";
                    }
                    else{
                        $("#span_user")[0].innerHTML = "";
                        $.cookie('password', '', { expires: -1 });      //如果退出，不记录密码
                        $.cookie("rmbUser", 'false', { expire: -1 });   //如果退出，不记录密码
                        $("#a_exit").css("display","block");
                        $("#a_signout").css("display","none");
                        $("#span_user").css("display","none");
                    }
                    /*if(this.innerHTML != "登录") {
                     GDYB.GridProductClass.currentUserName = null;

                     $("#span_user")[0].innerHTML = "未登录";
                     $.cookie('password', '', { expires: -1 });      //如果退出，不记录密码
                     $.cookie("rmbUser", 'false', { expire: -1 });   //如果退出，不记录密码
                     this.innerHTML = "登录";
                     }
                     else if(this.innerHTML == "登录") {
                     window.location.href="index.html";
                     }*/
                });

                var userName = $.cookie("userName");
                var password = $.cookie("password");
                if (userName != null && password != null) {
                    if(typeof($("#span_user")[0]) != "undefined" && typeof($("#a_exit")[0]) != "undefined"){
                        $("#span_user")[0].innerHTML = $.cookie("showName");
                        $("#span_user").css("display","");
                        $("#a_exit").css("display","none");
                        $("#a_signout").css("display","block");
                    }
                }
                else{
                    if(typeof($("#a_exit")[0]) != "undefined"){
                        $("#a_exit").css("display","block");
                        $("#a_signout").css("display","none");
                    }
                }

                $("#user_img").click(function(){
                    if($("#user_hid").is(":hidden")){
                        $("#user_hid").slideDown();
                    }
                    else{
                        $("#user_hid").css("display","none");
                    }
                });

                if (userName != null && password != null) {
                    var url = "http://172.23.2.237:8080/WMGridService/services/AreaService/getDepartByUser";
                    $.ajax({
                        data: { "para": "{userName:'" + userName + "'}" },
                        url: url,
                        dataType: "json",
                        type: "POST",
                        success: function (data) {
                            if (typeof (data) != "undefined") {
                                $.cookie('departCode', data.departCode, { expires: 60 });
                                userDepartCode = data.departCode;
                                userDepartName = data.departName;
                                getUserAreaName();
                                if (userDepartCode != null) {
                                    var img = document.getElementById("imgproduct");
                                    img.src = "http://172.23.2.237:8080/gdyb/imgs/output/"+userDepartCode+"/output.png?rnd=" + Math.random();
                                }

                                //市、县的边界、名称勾选框
                                if(userDepartCode.length != 2){
                                    $("#vtCheckboxSpan").css("display","block");
                                }
                            } else {
                                console.log("没有查询到结果");
                            }
                        },
                        error: function (e) {
                            console.log("获取部门错误");
                            alert("获取用户所在部门失败：" + e.statusText);
                        }
                    });
                }
                else {
                    alertModal("请登录");
                }

                //获取区域信息
                function getUserAreaName(){
                    var url = "http://172.23.2.237:8080/gdyb_test/data/gansu.json";
                    $.ajax({
                        data:{},
                        url:url,
                        dataType:"json",
                        type:"POST",
                        success:function(datas){
                            if(datas != null) {
                                var cities = datas.area;
                                var loopI = cities.length;
                                if (userDepartCode != 62) {
                                    var areaCode = userDepartCode;
                                    if(areaCode.length == 4){
                                        for(i = 0; i < loopI; i++){
                                            if(Number(areaCode) === cities[i].code){
                                                userAreaName = cities[i].name;
                                                break;
                                            }
                                        }
                                    } else {
                                        for (i = 0; i < loopI; i++) {
                                            var city = cities[i];
                                            if (Number(areaCode.substr(0,4)) === city.code) {
                                                cities = city.area;
                                                loopI = cities.length;
                                                for(j = 0; j < loopI; j++){
                                                    if(Number(areaCode) === cities[j].code){
                                                        userAreaName = cities[j].name;
                                                        break;
                                                    }
                                                }
                                                break;
                                            }
                                        }
                                    }
                                } else {
                                    userAreaName = datas.name;
                                }
                            } else {
                                console.log("没有查询到结果");
                            }
                        },
                        error: function (e) {
                            console.log("获取区域错误");
                            alert("获取用户所在区域失败：" + e.statusText);
                        }
                    });
                }
            }

            var initLegent = [
                {v:0.1, r:165, g:243, b:141},
                {v:10.0, r:61, g:185, b:63},
                {v:25.0, r:99, g:184, b:249},
                {v:50.0, r:0, g:0, b:254},
                {v:100.0, r:243, g:5, b:238},
                {v:250.0, r:129, g:0, b:64},
                {v:'', r:150, g:150, b:150},
                {v:'', r:150, g:150, b:150},
                {v:'', r:150, g:150, b:150},
                {v:'', r:150, g:150, b:150}
            ];
            var legentColors = [];
            setLegend();
            function setLegend(){
                var colorsBarHtml ='';
                var par = $("#fenduan select").val();
                legentColors = initLegent.slice(0,par);
                var barH = 30;
                var barW = (800/par);
                for(var i=0;i<par;i++){
                    //图例颜色rgb
                    var v = legentColors[i].v;
                    var r = legentColors[i].r;
                    var g = legentColors[i].g;
                    var b = legentColors[i].b;
                    if(i==0){
                        colorsBarHtml += '<div class="legentColor" flag="'+ i +'" style="background-color: rgb('+r+','+g+','+b+');width: '+ barW +'px;height: '+ barH +'px;"><input style="top: '+ (barH+10) +'px;left: -'+ (barW*2/3) +'px;" value="0" readonly><div style="position: relative;top:'+ (barH-10) +'px;width: 20px;margin: 0 auto;">--</div></div>';
                    }else{
                        colorsBarHtml += '<div class="legentColor" flag="'+ i +'" style="background-color: rgb('+r+','+g+','+b+');width: '+ barW +'px;height: '+ barH +'px;"><input id="lineValue'+ i +'" style="top: '+ (barH+10) +'px;left: -'+ (barW*2/3) +'px;" value="'+ v +'"><div style="position: relative;top:'+ (barH-10) +'px;width: 20px;margin: 0 auto;">--</div></div>';
                    }
                }
                colorsBarHtml += '<div id="btn_submit">保存</div>';
                $("#colorsBar").html(colorsBarHtml);
                creatColorTool();
                //保存图例
                $("#btn_submit").click(function(){
                    var b = true;
                    var legents = $("#colorsBar").find("div.legentColor");
                    var size = legents.length;
                    var value,valuePre=0,color,rgb,cR,cG,cB;
                    legentColors = [];
                    for(var i=0;i<size;i++){
                        value = $("#colorsBar").find("div.legentColor:eq("+i+") input").val();
                        if(i>0){
                            valuePre = $("#colorsBar").find("div.legentColor:eq("+(i-1)+") input").val();
                        }
                        if(value-valuePre<0){
                            b = false;
                            break;
                        }
                        color = $("#colorsBar").find("div.legentColor:eq("+i+")").css("background-color");
                        rgb = color.split(',');
                        cR = parseInt(rgb[0].split('(')[1]);
                        cG = parseInt(rgb[1]);
                        cB = parseInt(rgb[2].split(')')[0]);
                        legentColors.push({v:value, r:cR, g:cG, b:cB});
                    }
                    if(b)
                        alert("图例保存成功");
                    else
                        alert("图例定值不正确");
                });
            }
            $("#fenduan select").change(setLegend);

            //创建颜色选择器
            function creatColorTool(){
                $(".legentColor").colpick({
                    colorScheme:'dark',
                    layout:'rgbhex',
                    onSubmit:function(hsb,hex,rgb,el) {
                        $(el).css('background-color', 'rgb('+rgb.r+','+rgb.g+','+rgb.b+')');
                        $(el).colpickHide();
                        //alert('hsb:'+hsb+'|hex:'+hex+'|rgb:('+rgb.r+','+rgb.g+','+rgb.b+')|el:'+el);
                    }
                });
            }
            //颜色转码--rgb转16进制
            function colorRGB2Hex(color) {
                var rgb = color.split(',');
                var r = parseInt(rgb[0].split('(')[1]);
                var g = parseInt(rgb[1]);
                var b = parseInt(rgb[2].split(')')[0]);

                var hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
                return hex;
            }

            //日期时间加上小时数，hours如果是小数就是加减分钟或者秒
            function addHour(date, hours){
                return new Date(date.getTime()+hours*3600*1000);
            }

            //格式化日期时间
            //  date：Date，日期时间
            //  isZh：bool，是否中文
            //  local：bool，是否datetime-local格式
            function formatDate(date, isZh, local){
                var year = date.getFullYear();
                var month = date.getMonth()+1;
                var day = date.getDate();
                var hour = date.getHours();
                var minutes = 0;
                var seconds = 0;
                if(isZh){
                    return year + "年" + (Array(2).join(0)+month).slice(-2) + "月" + (Array(2).join(0)+day).slice(-2) + "日 " + (Array(2).join(0)+hour).slice(-2) + "时";
                }
                else{
                    return year + "-" + (Array(2).join(0)+month).slice(-2) + "-" + (Array(2).join(0)+day).slice(-2) + (local?"T":" ") + (Array(2).join(0)+hour).slice(-2) + ":" + (Array(2).join(0)+minutes).slice(-2)+":"+(Array(2).join(0)+seconds).slice(-2);
                }
            }

            $("#btn_run").click(function(){
                if($("#elseDataInput").val()==""){
                    alertModal("自定义阀值不能为空");
                    return;
                }
                run();//出图
            });
            $("#btn_runFromTable").click(function(){
                runFromTable();//根据表格出图
            });
            $("#btn_creatRainWord").click(function(){
                creatRainWord();//生成雨情快报                
            });
            $("#btn_setLegend").click(function(){//编辑图例
                if($(this).hasClass("active")){
                    $(this).removeClass("active");
                    $("#setLegendDiv").slideUp();
                }else{
                    $(this).addClass("active");
                    $("#setLegendDiv").slideDown();
                }
            });
            $("#thresholdDiv input[type='radio']").click(function(){
                var inputEle = $(this).parent().find("#elseDataInput");
                if($(this).val()=="elseData"){
                    inputEle.attr("disabled",false);
                    inputEle.select();
                }else{
                    inputEle.attr("disabled",true);
                }
            });

            //过滤表格填值
            $("#formThresholdDiv input[type='radio']").click(function(){
                if(tableJsonData.length != 0 && $("#rightTable").css("display") != "none")
                    creatDatalistTable(tableJsonData);
                else
                    alert("请先点击出图！");
            });

            function run(){
//                var ObservTimesStart = "2016070108";
//                var ObservTimesEnd = "2016070208";
//                var tableName = "HIS_HOUR_201607";

                var ObservTimesStart = $("#dateStart").val();
                ObservTimesStart = ObservTimesStart.replace(/-/g, "");
                ObservTimesStart = ObservTimesStart.replace(/T/g, "");
                ObservTimesStart = ObservTimesStart.substr(0, 10);
                var ObservTimesEnd = $("#dateEnd").val();
                ObservTimesEnd = ObservTimesEnd.replace(/-/g, "");
                ObservTimesEnd = ObservTimesEnd.replace(/T/g, "");
                ObservTimesEnd = ObservTimesEnd.substr(0, 10);
                if(ObservTimesStart.substr(0, 6) != ObservTimesEnd.substr(0, 6)){
                    alert("错误：起止时间不能跨月");
                    return;
                }
				var tableName = "HIS_HOUR_"+ObservTimesStart.substr(0, 6);
				var stationType =  $("#checkNation").is(":checked")?"5%":"%";
                var bShowValue =  $("#checkShowValue").is(":checked");
                var bRemoveZero =  $("#checkRemoveZero").is(":checked");
                var threshold = $("#thresholdDiv input:checked").val()!="elseData"?($("#thresholdDiv input:checked").val()):($("#elseDataInput").val());//出图显示阈值
                var bVtBoundary = $("#vtBoundary").is(":checked");
                var bVtName = $("#vtName").is(":checked");
                var legent = legentColors;
                alert("正在出图，请稍后...");
                $.ajax({
                    type: 'post',
                    url: "http://172.23.2.237:8082/GSGraphicService/services/GraphicsService/getStationDetailByTimes",
					data: {"para": "{ObservTimesStart:'" + ObservTimesStart + "',ObservTimesEnd:'" + ObservTimesEnd + "',tableName:'" + tableName + "',type:"+stationType+ ",bShowValue:"+ bShowValue+ ",bRemoveZero:"+ bRemoveZero +",threshold:"+ threshold +",legent:"+ JSON.stringify(legent) +",areaCode:'"+ userDepartCode +"',bVtBoundary:"+ bVtBoundary +",bVtName:"+ bVtName +"}"},
                    dataType: 'json',
                    error: function (e) {
						if(e.status == 0)
							alert('错误：服务已关闭');
						else
							alert('错误：错误码为'+e.status);
                    },
                    success: function (data) {
                        if(typeof(data) == "undefined"){
                            alert("无数据");
                        }
                        else{
                            tableJsonData = data;
							var img = document.getElementById("imgproduct");
							img.src = "http://172.23.2.237:8080/gdyb/imgs/output/"+userDepartCode+"/output.png?rnd=" + Math.random();
                            alert("出图已完成，如果图片未刷新可按CTRL+F5强制刷新");
                            creatDatalistTable(data);
                        }
                    }
                });
            }

            //按表格数据出图
            function runFromTable(){
                if(tableJsonData.length==0){
                    alert("请先点击出图！");
                    return;
                }
                var ObservTimesStart = $("#dateStart").val();
                ObservTimesStart = ObservTimesStart.replace(/-/g, "");
                ObservTimesStart = ObservTimesStart.replace(/T/g, "");
                ObservTimesStart = ObservTimesStart.substr(0, 10);
                var ObservTimesEnd = $("#dateEnd").val();
                ObservTimesEnd = ObservTimesEnd.replace(/-/g, "");
                ObservTimesEnd = ObservTimesEnd.replace(/T/g, "");
                ObservTimesEnd = ObservTimesEnd.substr(0, 10);
                if(ObservTimesStart.substr(0, 6) != ObservTimesEnd.substr(0, 6)){
                    alert("错误：起止时间不能跨月");
                    return;
                }
                var stationType =  $("#checkNation").is(":checked")?"5%":"%";
                var bShowValue =  $("#checkShowValue").is(":checked");
                var bRemoveZero =  $("#checkRemoveZero").is(":checked");
                var threshold = $("#thresholdDiv input:checked").val()!="elseData"?($("#thresholdDiv input:checked").val()):($("#elseDataInput").val()==""?0:$("#elseDataInput").val());//出图显示阈值
                var bVtBoundary = $("#vtBoundary").is(":checked");
                var bVtName = $("#vtName").is(":checked");
                var legent = legentColors;
                alert("正在表格数据出图，请稍后...");
                points = tableJsonData;
                $.ajax({
                    type: 'post',
                    url: "http://172.23.2.237:8082/GSGraphicService/services/GraphicsService/outputImageByJson",
                    data: {"para": "{ObservTimesStart:'" + ObservTimesStart + "',ObservTimesEnd:'" + ObservTimesEnd + "',type:"+stationType+ ",bShowValue:"+ bShowValue + ",bRemoveZero:"+ bRemoveZero + ",threshold:"+ threshold +",points:"+ JSON.stringify(points) +",legent:"+ JSON.stringify(legent) +",areaCode:'"+ userDepartCode +"',bVtBoundary:"+ bVtBoundary +",bVtName:"+ bVtName +"}"},
                    dataType: 'json',
                    error: function (e) {
                        if(e.status == 0)
                            alert('错误：服务已关闭');
                        else
                            alert('错误：错误码为'+e.status);
                    },
                    success: function (b) {
                        if(!b){
                            alert("根据表格出图失败");
                        }else{
                            var img = document.getElementById("imgproduct");
                            img.src = "http://172.23.2.237:8080/gdyb/imgs/output/"+userDepartCode+"/output.png?rnd=" + Math.random();
                            alert("根据表格出图完成");
                            creatDatalistTable(points);
                        }
                    }
                });
            }

            function alertModal(message){
                $("#div_alert_content").html(message);
                $("#div_alert").modal();
            }

            //word产品生成
            function creatRainWord(){
                if(tableJsonData.length==0){
                    alert("请先点击出图！");
                    return;
                }
                var ObservTimesStart = $("#dateStart").val();
                ObservTimesStart = ObservTimesStart.replace(/-/g, "");
                ObservTimesStart = ObservTimesStart.replace(/T/g, "");
                ObservTimesStart = ObservTimesStart.substr(0, 10);
                var ObservTimesEnd = $("#dateEnd").val();
                ObservTimesEnd = ObservTimesEnd.replace(/-/g, "");
                ObservTimesEnd = ObservTimesEnd.replace(/T/g, "");
                ObservTimesEnd = ObservTimesEnd.substr(0, 10);
                if(ObservTimesStart.substr(0, 6) != ObservTimesEnd.substr(0, 6)){
                    alert("错误：起止时间不能跨月");
                    return;
                }
                var myDate = new Date();
                var yearNow = myDate.getFullYear();
                var MMNow = (myDate.getMonth()+1).toString().length>1?(myDate.getMonth()+1):("0"+(myDate.getMonth()+1));
                var ddNow = myDate.getDate().toString().length>1?myDate.getDate():("0"+myDate.getDate());
                var hhNow = myDate.getHours().toString().length>1?myDate.getHours():("0"+myDate.getHours());
                var mmNow = myDate.getMinutes().toString().length>1?myDate.getMinutes():("0"+myDate.getMinutes());
                var timeNow = yearNow+" 年 "+MMNow+" 月 "+ddNow+" 日 ";

                var yyyySta = ObservTimesStart.substr(0,4);
                var MMSta = ObservTimesStart.substr(4,2).substr(0,1)==0?ObservTimesStart.substr(4,2).substr(1,1):ObservTimesStart.substr(4,2);
                var ddSta = ObservTimesStart.substr(6,2).substr(0,1)==0?ObservTimesStart.substr(6,2).substr(1,1):ObservTimesStart.substr(6,2);
                var hhSta = ObservTimesStart.substr(8,2).substr(0,1)==0?ObservTimesStart.substr(8,2).substr(1,1):ObservTimesStart.substr(8,2);
                var yyyyEnd = ObservTimesEnd.substr(0,4);
                var MMEnd = ObservTimesEnd.substr(4,2).substr(0,1)==0?ObservTimesEnd.substr(4,2).substr(1,1):ObservTimesEnd.substr(4,2);
                var ddEnd = ObservTimesEnd.substr(6,2).substr(0,1)==0?ObservTimesEnd.substr(6,2).substr(1,1):ObservTimesEnd.substr(6,2);
                var hhEnd = ObservTimesEnd.substr(8,2).substr(0,1)==0?ObservTimesEnd.substr(8,2).substr(1,1):ObservTimesEnd.substr(8,2);

                productName = yearNow+"年区域站雨情快报传真-"+MMNow+ddNow+hhNow+mmNow;

                var rainAreaNum = 0;//降水乡镇数
                var rainAreaX = 0;//小雨乡镇数
                var rainAreaZ = 0;//中雨乡镇数
                var rainAreaD = 0;//大雨乡镇数
                var rainAreaB = 0;//暴雨乡镇数
                var rainAreaDB = 0;//大暴雨乡镇数
                var rainAreaTDB = 0;//特大暴雨乡镇数
                var max5Areas = tableJsonData.slice(0,5);//降雨量最大的5个乡镇信息
                $.each(tableJsonData,function(i){
                    if(tableJsonData[i].Precipitation>0){rainAreaNum += 1;}
                    if(tableJsonData[i].Precipitation>=0.1 && tableJsonData[i].Precipitation<10){rainAreaX += 1}
                    if(tableJsonData[i].Precipitation>=10 && tableJsonData[i].Precipitation<25){rainAreaZ += 1}
                    if(tableJsonData[i].Precipitation>=25 && tableJsonData[i].Precipitation<50){rainAreaD += 1}
                    if(tableJsonData[i].Precipitation>=50 && tableJsonData[i].Precipitation<100){rainAreaB += 1}
                    if(tableJsonData[i].Precipitation>=100 && tableJsonData[i].Precipitation<250){rainAreaDB += 1}
                    if(tableJsonData[i].Precipitation>=250 ){rainAreaTDB += 1}
                });
                var content = ddSta+"日"+hhSta+"时至"+ddEnd+"日"+hhEnd+"时，共计"+rainAreaNum+"个乡镇出现降水，"
                        +(rainAreaX==0?"":"其中小雨"+rainAreaX+"个，")
                        +(rainAreaZ==0?"":"中雨"+rainAreaZ+"个，")
                        +(rainAreaD==0?"":"大雨"+rainAreaD+"个，")
                        +(rainAreaB==0?"":"暴雨"+rainAreaB+"个，")
                        +(rainAreaDB==0?"":"大暴雨"+rainAreaDB+"个，")
                        +(rainAreaTDB==0?"":"特大暴雨"+rainAreaTDB+"个，")+"较大降水量出现在："
                        +max5Areas[0].StationName+max5Areas[0].Precipitation+"mm、"
                        +max5Areas[1].StationName+max5Areas[1].Precipitation+"mm、"
                        +max5Areas[2].StationName+max5Areas[2].Precipitation+"mm、"
                        +max5Areas[3].StationName+max5Areas[3].Precipitation+"mm、"
                        +max5Areas[4].StationName+max5Areas[4].Precipitation+"mm。";
                var imgElement = document.getElementById("imgproduct");
                var data = getBase64Image(imgElement);
                var img = data.replace("data:image/png;base64,","");
                var title = yyyySta+"年"+MMSta+"月"+ddSta+"日"+hhSta+"时~"+yyyyEnd+"年"+MMEnd+"月"+ddEnd+"日"+hhEnd+"时降水实况(单位:毫米)";
                var dataList = [];
                var count = tableJsonData.length;
                var formThresholdNum = parseFloat($("#formThresholdDiv input:checked").val());
                if(formThresholdNum < 0){
                    count = 60;
                }
                for(var i=0;i<count;i+=2){
                    if(tableJsonData[i].Precipitation!=0){
                        dataList.push({
                            area1:tableJsonData[i].area==null?"无":tableJsonData[i].area,
                            stationName1:tableJsonData[i].StationName,
                            stationNum1:tableJsonData[i].StationNum,
                            prec1:tableJsonData[i].Precipitation,
                            area2:tableJsonData[i+1].Precipitation==0||tableJsonData[i+1].area==null?"无":tableJsonData[i+1].area,
                            stationName2:tableJsonData[i+1].Precipitation==0?"":tableJsonData[i+1].StationName,
                            stationNum2:tableJsonData[i+1].Precipitation==0?"":tableJsonData[i+1].StationNum,
                            prec2:tableJsonData[i+1].Precipitation==0?"":tableJsonData[i+1].Precipitation
                        });
                    }
                }
                var archiveService = "http://172.23.2.237"+":8080/SPDArchiveService/";
                var url = archiveService + "services/ArchiveService/createProduct";
                $.ajax({
                    data: {"para": "{templateName:'rain.ftl',productName:'" + productName + ".doc',areaName:'"+ userAreaName +"',departName:'"+ userDepartName +"',timeNow:'"+ timeNow +"',content:'"+ content +"',img:'"+ img +"',title:'"+ title +"',dataList:"+ JSON.stringify(dataList) +"}"},
                    url: url,
                    dataType: "json",
                    success: function (data) {
                        if(data){
							alert("文档生成成功");
							wordDownload();//下载到本地
						}
                        else
                            alert("文档生成失败");
                    },
                    error:function(data){
                    },
                    type: "POST"
                });
            }

            //word产品下载
            function wordDownload(){
                window.location.href="http://172.23.2.237:8080/products/archive/"+ productName+".doc";
            }

            function getBase64Image(img) {
                var canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;

                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, img.width, img.height);

                var dataURL = canvas.toDataURL("image/png");
                return dataURL;
                // return dataURL.replace("data:image/png;base64,", "");
            }

            function alert(content){
                $("#divAlert").html(content);
            }

            //删除表格中的0值
            $("#delete0FromData").click(function(){
                if(tableJsonData.length==0){
                    alert("请先点击出图！");
                    return;
                }
                $("#div_modal_confirm_content").html("确认删除雨量为0的站点");
                $("#div_modal_confirm").modal();
                $("#div_modal_confirm").find("a").unbind();
                $("#div_modal_confirm").find("a").click(function(){
                    if(typeof(this.id) != "undefined"){
                        if(this.id == "btn_ok") {
                            for(var i=0;i<tableJsonData.length;i++){
                                if(tableJsonData[i].Precipitation == 0){
                                    tableJsonData.splice(i,tableJsonData.length);//数组中移除
                                    break;
                                }
                            }
                            creatDatalistTable(tableJsonData);
                        }
                    }
                });
            });
        });

        function creatDatalistTable(data){
            var area;
            var stationName;
            var stationNum;
            var stationData;
            var strHTML = '<div style="height: 30px;width: 98.5%">'
                    +'<table cellspacing="0" cellpadding="0">'
                    +'<thead><tr><th width="80px"></th><th width="185px">区县</th><th width="185px">站名</th><th width="185px">站号</th><th width="100px">降水量(mm)</th><th width="100px">操作</th></tr></thead>'
                    +'</table></div>'
                    +'<div style="overflow-y: auto;height: 770px"><table id="exeTable" cellspacing="0" cellpadding="0">'
                    +'<tbody>';
            var formThresholdNum = parseFloat($("#formThresholdDiv input:checked").val());
            var dataLength = data.length;
            if(formThresholdNum < 0){
                if(dataLength>60){
                    dataLength = 60;
                }
                formThresholdNum = 0;
            }
            for(var i = 0;i<dataLength;i++){
                area = data[i].area;
                stationName = data[i].StationName;
                stationNum = data[i].StationNum;
                stationData = data[i].Precipitation;
                if(stationData >= formThresholdNum){
                    strHTML += '<tr>'
                            +'<td style="background-color: rgba(140,140,140,0.2);" width="80px">'+ (parseInt(i)+1).toString() +'</td>'
                            +'<td width="185px" class="stationDistrict">'+ area +'</td>'
                            +'<td width="185px" class="stationName">'+ stationName +'</td>'
                            +'<td width="185px" class="stationNum">'+ stationNum +'</td>'
                            +'<td width="100px" class="tableData">'+ stationData +'</td>'
                            +'<td width="100px" class="delStation">删除</td>'
                            +'</tr>';
                }
            }
            strHTML += '</tbody></table></div>';
            $("#rightTable").html(strHTML).css("display","block");

            //更改数据
            $(".rightTable table tr").find("td.tableData").click(function() {
                var obj_text = $(this).find("input:text");
                var stationNum = $(this).parent().find("td.stationNum").html();
                if(!obj_text.length){
                    elementSkip();
                    $(this).html("<input style='width: 100%;' type='text' value='"+$(this).text()+"' onblur='inputToHtml(this)'>");
                    $(this).find("input:text").select();
                } else {
                    var v = obj_text.val();
                    $(this).html(v);
                    for(var i=0;i<tableJsonData.length;i++){
                        if(tableJsonData[i].StationNum==stationNum)
                            tableJsonData[i].Precipitation=v;
                    }
                    sortListByPrecipitation(tableJsonData);
                }
            });

            function elementSkip(){
                $(".rightTable table tr").siblings("td.tableData").each(function(){
                    var data_text = $(this).find("input:text");
                    var stationNum = $(this).parent().find("td.stationNum").html();
                    if(data_text.length){
                        var v = data_text.val();
                        $(this).html(v);
                        for(var i=0;i<tableJsonData.length;i++) {
                            if (tableJsonData[i].StationNum == stationNum)
                                tableJsonData[i].Precipitation = v;
                        }
                    }
                });
            }

            //确认删除模态窗
            $(".rightTable table tr").find("td.delStation").click(function(){
                var stationNum = $(this).parent().find("td.stationNum").html();
                var this_parent = $(this).parent();
                $("#div_modal_confirm_content").html("确认删除站点【"+ stationNum +"】");
                $("#div_modal_confirm").modal();
                $("#div_modal_confirm").find("a").unbind();
                $("#div_modal_confirm").find("a").click(function(){
                    if(typeof(this.id) != "undefined"){
                        if(this.id == "btn_ok") {
                            this_parent.remove();//表格中移除
                            for(var i=0;i<tableJsonData.length;i++){
                                if(tableJsonData[i].StationNum==stationNum)
                                    tableJsonData.splice(i,1);//数组中移除
                            }
                        }
                    }
                })
            });

            $(".delStation").hover(function(){
                $(this).parent().css({"border-color":"2px solid red","color":"red"});
            },function(){
                $(this).parent().css({"border-color":"1px solid #000","color":"black"});
            });
        }

        function inputToHtml(ele){
            var stationNum = $(ele).parent().parent().find("td.stationNum").html();
            $(ele).parent().html($(ele).val());
            for(var i=0;i<tableJsonData.length;i++){
                if(tableJsonData[i].StationNum==stationNum)
                    tableJsonData[i].Precipitation=$(ele).val();
            }
            sortListByPrecipitation(tableJsonData);
        }

        //根据降雨量排序
        function sortListByPrecipitation(arr){
            arr.sort(function(a,b){
                return b.Precipitation-a.Precipitation;
            });
        }
    </script>
</head>
<body>
    <div class="banner">
        <div class="logo">
            <img src="imgs/logo1.png" height="100%"><span style=" font-size: 27px;display: inline-block;font-family: 宋体;margin-left: 50px;float: right;margin-top: 15px;">甘肃省雨情业务</span>
        </div>
        <!--登录按钮-->
        <div id="login" class="loginInfo">
            <div id="user_img" style="padding-right: 2px;">
            </div>
            <span id="span_user" style="display: none;"></span><a id="a_exit" style="float: left;">登录</a>
            <div id="user_hid">
                <ul>
                    <li id="a_signout"><a title="退出">注销登录</a></li>
                    <li><a href="./docs/GDYB_UserManual.pdf" target="_blank" title="用户手册">用户手册</a></li>
                </ul>
            </div>
        </div>
    </div>
	<div id="mainDiv">
        <div id="leftTable" class="leftTable">
            <div id="divAlert">温馨提示：每次改变参数都需要点击出图按钮才能生效；图片右键可另存本机；目前不支持跨月查询。</div>
            <div style="padding: 10px 0 40px 0;">
                <div style="float:left;height: 32px;line-height: 32px;">开始时间：</div>
                <input type="datetime-local" value="2017-01-01T08:00:00" id="dateStart" style="float:left;height:24px;line-height: 32px;margin-top: 3px;"/>
                <div style="float:left;height: 32px;line-height: 32px;margin-left:20px;">结束时间：</div>
                <input type="datetime-local" value="2017-01-02T08:00:00" id="dateEnd" style="float:left;height:24px;line-height: 32px;margin-top: 3px;"/>
                <span style="float:left;height:32px;line-height: 32px;margin:2px 5px 0 20px;">仅国家站</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="checkbox" id="checkNation" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 5px 0 20px;">填值显示</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="checkbox" id="checkShowValue" checked />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 5px 0 20px;">去掉0值</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="checkbox" id="checkRemoveZero" checked />
                <span id="vtCheckboxSpan" style="display: none;">
                    <span style="float:left;height:32px;line-height: 32px;margin:2px 5px 0 20px;">乡镇边界</span>
                    <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="checkbox" id="vtBoundary" checked />
                    <span style="float:left;height:32px;line-height: 32px;margin:2px 5px 0 20px;">乡镇名称</span>
                    <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="checkbox" id="vtName" checked />
                </span>
            </div>
            <div style="float: left;height: 32px;line-height: 32px;">出图填值范围：</div>
            <div id="thresholdDiv" style="float: left;width: 80%;">
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="radio" name="thresholdVal" value="elseData" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 0 0 5px;">>=</span>
                <input style="float:left;height:18px;line-height: 32px;;width:70px;margin:8px 16px 0 10px;" id="elseDataInput" onkeyup='this.value=this.value.replace(/\D/gi,"")' name="thresholdVal" value="自定义" disabled />
                <input style="float:left;height:18px;line-height: 32px;width:18px;margin-top: 8px;" type="radio" name="thresholdVal" value="0.1" checked/>
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">>=0.1</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="radio" name="thresholdVal" value="10" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">>=10</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="radio" name="thresholdVal" value="25" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">>=25</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="radio" name="thresholdVal" value="50" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">>=50</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="radio" name="thresholdVal" value="100" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">>=100</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="radio" name="thresholdVal" value="250" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">>=250</span>
            </div>
            <div style="clear:both;"></div>
            <div style="float: left;height: 32px;line-height: 32px;">表格显示范围：</div>
            <div id="formThresholdDiv" style="float: left;width: 80%;">
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="radio" name="formThresholdVal" value="-1" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">默认</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="radio" name="formThresholdVal" value="0" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">>=0</span>
                <input style="float:left;height:18px;line-height: 32px;width:18px;margin-top: 8px;" type="radio" name="formThresholdVal" value="0.1" checked/>
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">>=0.1</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="radio" name="formThresholdVal" value="10" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">>=10</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="radio" name="formThresholdVal" value="25" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">>=25</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="radio" name="formThresholdVal" value="50" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">>=50</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="radio" name="formThresholdVal" value="100" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">>=100</span>
                <input style="float:left;height:18px;line-height: 32px;;width:18px;margin-top: 8px;" type="radio" name="formThresholdVal" value="250" />
                <span style="float:left;height:32px;line-height: 32px;margin:2px 20px 0 5px;">>=250</span>
                <button id="delete0FromData" style="margin: 4px 0 0 -150px;">删除表格0值</button>
            </div>
            <div style="clear:both;"></div>
            <div class="btns" style="height: 40px; ">
                <div id="btn_run" class="btn_run">出  图</div>
                <div id="btn_runFromTable" class="btn_run">按表格出图</div>
                <div id="btn_creatRainWord" class="btn_run">生成雨情快报</div>
                <div id="btn_setLegend" class="btn_run">设置图例</div>
            </div>
            <div id="setLegendDiv">
                <div id="fenduan" style="position: relative;top: 25px;left: 10px;width: 100px;">
                    分段：<select><option>2</option><option>3</option><option>4</option><option>5</option><option selected>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select>
                </div>
                <div id="colorsBar" style="position:relative;top: 0;left: 150px;width: 80%;">

                </div>
            </div>
            <div style="text-align: left;">
                <img id="imgproduct" src="http://172.23.2.237:8080/gdyb/imgs/output/output.png">
            </div>
        </div>
        <div id="rightTable" class="rightTable"></div>
        <div style="clear: both;"></div>
	</div>
    <div id="div_modal_confirm" class="modal fade in" style="display: none; ">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <a class="close" data-dismiss="modal">×</a>
                    <h3>提示</h3>
                </div>
                <div id="divImportModelType" class="modal-body">
                    <h4 id="div_modal_confirm_content">是否交叉订正</h4>
                </div>
                <div class="modal-footer">
                    <a id="btn_canel" href="#" class="btn" data-dismiss="modal">取消</a>
                    <a id="btn_ok" href="#" data-dismiss="modal" class="btn btn-success">确定</a>
                </div>
            </div>
        </div>
    </div>
    <div id="div_alert" class="modal fade in" style="display: none; ">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <a class="close" data-dismiss="modal">×</a>
                    <h3>提示</h3>
                </div>
                <div class="modal-body">
                    <h4 id="div_alert_content"></h4>
                </div>
                <div class="modal-footer">
                    <a id="alert_ok" href="#" data-dismiss="modal" class="btn btn-success">确定</a>
                </div>
            </div>
        </div>
    </div>
</body>
</html>