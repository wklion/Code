/**
 * Created by Dinlerkey on 2017/10/17.
 */


function QDLQXFXPageClass() {
    var t = this;
    this.myDateSelecter = null;
    this.myBarDateSelecter = null;
    this.numbers = [3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69, 72, 75, 78, 81, 84, 87, 90, 93, 96, 99, 102, 105, 108, 111, 114, 117, 120, 123, 126, 129, 132, 135, 138, 141, 144, 147, 150, 153, 156, 159, 162, 165, 168, 171, 174, 177, 180, 183, 186, 189, 192, 195, 198, 201, 204, 207, 210, 213, 216, 219, 222, 225, 228, 231, 234, 237, 240];
    this.hourSpan = null;
    this.levelColor = ["red", "orange", "yellow", "blue"];
    this.levelTxt = ["风险很高", "风险高", "风险较高", "有一定风险"];
    this.drawPolygon = null;
    this.riverLayer = null;//中小河流图层
    this.shLayer = null;//山洪沟图层
    this.disasterLayer = null;//隐患点图层
    this.allCounty = [];//所有区县
    this.mostAlarmLevel = "蓝色";
    this.renderMenu =async function () {
        //监测报警
        $("#menu_bd").html(`
            <div id="monitoringAlarmDiv">
                <div id="alarmStrategy">
                    <div class="title1">报警策略：</div>
                    <div class="" style="padding: 5px 0 10px 10px;">
                        <button id="strategy_live" class="active">实况</button><button id="strategy_liveAndForecast">实况+预报</button><button id="strategy_forecast">预报</button>
                    </div>
                </div>
                <div id="riskType">
                    <div class="title1">风险类型：</div>
                    <div class="" style="padding: 5px 0 10px 10px;">
                        <button id="type_shanhong" class="active">山洪</button><button id="type_dizhizaihai" class="active">地质灾害</button><button id="type_hongshui" class="active">中小河流洪水</button>
                    </div>
                </div>
                <div id="alarmMessage">
                    <div class="title1">报警消息：</div>
                    <div style="padding: 5px 0 10px 5px;">
                        <div id="alarmMessageTable" style="width: 95%;margin: 0 auto;color: #eee;">
                        </div>
                    </div>
                </div>
                <div id="monitoringAlarmBar">
                    <div style="margin-left: 10px;float: left;">面雨量</div>
                    <div style="margin-left: 10px;float: left;">日期：</div>
                    <div id="barDateSelect" style="float: left;"></div>
                    <div style="margin-left: 10px;float: left;">小时：</div>
                    <div style=";float: left;">
                        <select id="selectMakeTime" style="height: 25px;border: 1px solid #aaa;background-color: transparent;">
                            <option value="5">08</option>
                            <option value="16">20</option>
                        </select>
                    </div>
                    <div id="timeChooseBar" style="margin-left: 20px;float: left;">
                        <ul>
                            <li flag="-24">-24</li>
                            <li flag="-12">-12</li>
                            <li flag="-6">-6</li>
                            <li flag="-3">-3</li>
                            <li flag="-1">-1</li>
                            <li flag="1">+1</li>
                            <li flag="3">+3</li>
                            <li flag="6">+6</li>
                            <li flag="12">+12</li>
                            <li flag="24">+24</li>
                            <li flag="48">+48</li>
                            <li flag="72">+72</li>
                        </ul>
                    </div>
                    <div style="clear:both;"></div>
                    <div id="monitoringAlarmTableDiv" style="display: none;">
                        <div id="displayTableDiv">x</div>
                        <div id="monitoringAlarmTable"></div>
                    </div>
                </div>
            </div>
        `);
        //预警制作
        $("#menu_bd").append(`
            <div id="makeAlarmDiv" style="color:#eee;display:none;">
                <div id="makeAlarmForm" style="padding: 5px 0 10px 10px;">
                    <div id="alarmFormContent">
                        <div style="float: left;margin: 6px;">起报时间：</div>
                        <div id="dateSelect" style="float: left;margin: 6px 0 0 2px""></div><div style="clear:both;"></div>
                        <div style="float: left;margin: 6px;">预报时效：</div>
                        <div style="float: left;margin: 6px 0 0 2px">
                            <select id="forecastHourspan" style="background-color: rgba(3,66,94,0.9);height: 22px;border:1px solid rgb(49, 202, 255)">
                                <option>24小时</option><option>12小时</option>
                           </select>
                        </div>
                        <div style="float: left;margin: 6px 0 0 20px;">期号：</div>
                        <div style="float: left;margin: 6px 0 0 2px""><input id="alarmIssue" type="text" style="text-align: center;width: 68px;background-color: transparent;height: 22px;border:1px solid rgb(49, 202, 255)" value="45"/></div><div style="clear:both;"></div>
                        <div style="float: left;margin: 6px;">风险类型：</div>
                        <div style="float: left;margin: 6px 0 0 2px">
                            <select id="alarmType" style="background-color: rgba(3,66,94,0.9);height: 22px;width: 200px;border:1px solid rgb(49, 202, 255)">
                                <option>山洪灾害气象风险预警</option><option>地质灾害气象风险预警</option><option>中小河流灾害气象风险预警</option>
                            </select>
                        </div><div style="clear:both;"></div>
                        <div style="float: left;margin: 6px;">签发人：</div>
                        <div style="float: left;margin: 6px 0 0 16px">
                            <select id="alarmSigner" style="background-color: rgba(3,66,94,0.9);height: 22px;border:1px solid rgb(49, 202, 255)">
                                <option>王宝鉴</option><option>刘新伟</option>
                            </select>
                        </div>
                        <div style="float: left;margin: 6px;">预报员：</div>
                        <div style="float: left;margin: 6px 0 0 0">
                            <select id="alarmForecastor" style="background-color: rgba(3,66,94,0.9);height: 22px;border:1px solid rgb(49, 202, 255)">
                                <option>孔祥伟</option><option>黄武斌</option>
                            </select>
                        </div><div style="clear:both;"></div>
                    </div>
                    <div id="alarmFormButton" style="margin: 15px 0 15px;">
                        <button id="make_alarm">生成预警</button><button id="make_product">生成产品</button><button id="make_uploadProduct">上传产品</button>
                    </div>
                </div>
                <div id="dropZoneCorrection" style="padding: 5px 0 10px 10px;font-size: 14px;background-color: rgba(68,68,68,0.5);">
                    <div>落区订正</div>
                    <div style="width: 100%;margin: 0 auto;display: flex;flex-wrap: wrap;">
                        <div class="dropZoneLevel" value="1">
                            <div style="background-color:red;height:15px;width:15px;margin: 4px 10px 4px 10px;"></div><div class="levelDetail">一级：风险很高</div>
                        </div>
                        <div class="dropZoneLevel" value="2">
                            <div style="background-color:orange;height:15px;width:15px;margin: 4px 10px 4px 10px;"></div><div class="levelDetail">二级：风险高</div>
                        </div>
                        <div class="dropZoneLevel" value="3">
                            <div style="background-color:yellow;height:15px;width:15px;margin: 4px 10px 4px 10px;"></div><div class="levelDetail">三级：风险较高</div>
                        </div>
                        <div class="dropZoneLevel" value="4">
                            <div style="background-color:blue;;height:15px;width:15px;margin: 4px 10px 4px 10px;"></div><div class="levelDetail">四级：有一定风险</div>
                        </div>
                    </div>
                    <div id="dropZoneType" style="width: 60%;margin: 5px auto;">
                        <img style="width:14px;" src="imgs/pointer.png"/><button id="pointCorrection">站点订正</button>
                        <img style="width:14px;margin-left: 15px;" src="imgs/Circle.png"/><button id="areaEdit">落区订正</button>
                    </div>
                </div>
                <div style="padding: 5px 0 10px 10px;font-size: 14px;">
                    <div style="margin:5px 0 10px 0;">预览文本</div>
                    <div id="browseText" style="height:250px;width:95%;margin: 0 auto;border:1px #eee solid;padding: 5px;">
                        &nbsp;&nbsp;甘肃省气象台10月8日发布预警信息，受持续性降水影响，预计未来24小时，太原大部、吕梁大部、晋中北部、忻州中部、临汾北部等地部分区域地质灾害预警等级为2级（有高风险）；阳泉大部、清徐县、娄烦县、灵丘县、榆社县、和顺县、昔阳县、太谷县、祁县、平遥县、五台县、代县、繁峙县、静乐县、隰县、蒲县、霍州市、兴县、岚县、汾阳市等地部分区域地质灾害预警等级为3级（有较高风险）；其余地区为3级以下。请相关部门做好地质灾害防治工作。
                    </div>
                </div>
                <img id="productImg" src="imgs/demo02.png" style="display:none;"/>
                <div id="alarmProductListDiv">
                    <div style="margin:5px 0 10px 10px;">产品文件列表</div>
                    <div id="list_word" class="productList"><img style="width:20px;margin: 0 15px 0 15px;" src="imgs/icon_word.png"/>甘肃省地质灾害气象风险预警第45期.docx</div>
                    <div id="list_jpg" class="productList"><img style="width:20px;margin: 0 15px 0 15px;" src="imgs/icon_jpg.png"/>甘肃省地质灾害气象风险预警第45期.jpg</div>
                    <div id="list_txt" class="productList"><img style="width:20px;margin: 0 15px 0 15px;" src="imgs/icon_txt.png"/>Z_SEVP_C_BERZ_20171010083000_P...</div>
                </div>
                <div id="alarmProductListWindow" style="display:none;">
                    <div id="productWindowTitle">文档</div><div class="closeProductWindow">x</div>
                    <div id="productShow" style="width: 95%;height: 92%;margin:0 auto;background-color: #ddd;">
                    </div>
                    <div id="productControl">
                        <button id="product_uploadBtn">上传</button><button id="product_downloadBtn">下载</button>
                    </div>
                </div>
            </div>
        `);
        var pageTurnHtml = `
            <div class="getPageDiv">1</div>
            <div class="getPageDiv">2</div>
            <div class="getPageDiv">3</div>
            <div class="getPageDiv">4</div>
            <div class="getPageDiv">5</div>
            <div class="getPageDiv">6</div>
            <div class="getPageDiv">7</div>
            <div class="getPageDiv">8</div>
            <div class="getPageDiv">9</div>
            <div class="getPageDiv">10</div>
            <div style="clear: both;"></div>
        `;
        //产品查询
        $("#menu_bd").append(`
            <div id="queryAlarmDiv" style="display:none;color: #eee;">
                <div id="product_shanhong" class="alarmProductDiv">
                    <div class="productTitle">山洪灾害气象风险预警产品</div>
                    <div class="productContent">
                        <ul id="product_shanhong_list" style="text-decoration: none;">
                        </ul>
                        <div class="productTurnPage">`+ pageTurnHtml + `</div>
                    </div>
                </div>
                <div id="product_dizhizaihai" class="alarmProductDiv">
                    <div class="productTitle">地质灾害气象风险预警产品</div>
                    <div class="productContent">
                        <ul id="product_dizhizaihai_list" style="text-decoration: none;">
                        </ul>
                        <div class="productTurnPage">`+ pageTurnHtml + `</div>
                    </div>
                </div>
                <div id="product_hongshui" class="alarmProductDiv">
                    <div class="productTitle">中小河流灾害气象风险预警产品</div>
                    <div class="productContent">
                        <ul id="product_hongshui_list" style="text-decoration: none;">
                        </ul>
                        <div class="productTurnPage">`+ pageTurnHtml + `</div>
                    </div>
                </div>
                <div id="queryAlarmShowDiv">
                    <div id="queryAlarm_product" style="width:90%;margin: 30px auto;"></div>
                </div>
            </div>
        `);
        //底部按钮&图例
        $("#menu_bd").append(`
            <div id='bottomMenu'>
                <div class="scenicCheck">
                    <input type="checkbox" id="checkbox1" value="5" flag="中小河流" checked/>中小河流<label for="checkbox1"></label>
                </div>
                <div class="scenicCheck">
                    <input type="checkbox" id="checkbox2" flag="山洪沟" value="5"/>山洪沟<label for="checkbox2"></label>
                </div>
                <div class="scenicCheck">
                    <input type="checkbox" id="checkbox3" flag="地质灾害隐患点" value="5"/>地质灾害隐患点<label for="checkbox3"></label>
                </div>
            </div>
            <div id="riskLevelLegend">
                <ul>
                    <li><div style="background-color:blue;height:15px;width:15px;margin: 2px;float: left;"></div><div style="float: left;">有一定风险</div><div style="clear: both;"></div></li>
                    <li><div style="background-color:yellow;height:15px;width:15px;margin: 2px;float: left;"></div><div style="float: left;">风险较高</div><div style="clear: both;"></div></li>
                    <li><div style="background-color:orange;height:15px;width:15px;margin: 2px;float: left;"></div><div style="float: left;">风险高</div><div style="clear: both;"></div></li>
                    <li><div style="background-color:red;height:15px;width:15px;margin: 2px;float: left;"></div><div style="float: left;">风险很高</div><div style="clear: both;"></div></li>
                </ul>
            </div>
        `);

        $(".menu_changeDiv").html("<div name='jcbj' class='menu_change active'>监测报警</div><div name='yjzz' class='menu_change' style='margin-top: 5px;'>预警制作</div><div name='cpcx' class='menu_change' style='margin-top: 5px;'>产品查询</div>");

        //制作时间
        t.myDateSelecter = new DateSelecter(1, 1);
        t.myDateSelecter.intervalMinutes = 60;
        $("#dateSelect").html(t.myDateSelecter.div);
        $("#dateSelect").find("input").css("border", "1px solid #31CAFF").css("box-shadow", "none").css("color", "#eee").css("width", "200px");
        $("#dateSelect").find(".dateBtn").remove();

        //检测时间控制条
        t.myBarDateSelecter = new DateSelecter(2, 2);
        t.myBarDateSelecter.intervalMinutes = 60;
        $("#barDateSelect").html(t.myBarDateSelecter.div);
        $("#barDateSelect").find("input").css("height", "25px").css("background-color", "transparent").css("color", "#4DB8D7").css("width", "85px");
        $("#barDateSelect").find(".dateBtn").remove();

        //改变制作时间
        this.myBarDateSelecter.input.change(function () {
            var datetime = t.myBarDateSelecter.getCurrentTimeReal();
            var makeTimeHour = $("#selectMakeTime").val();
            setForecastTime(datetime, makeTimeHour);
            t.displayRainCover();
        });

        //改变制作时次
        $("#selectMakeTime").change(function () {
            var datetime = t.myBarDateSelecter.getCurrentTimeReal();
            var makeTimeHour = $("#selectMakeTime").val();
            setForecastTime(datetime, makeTimeHour);
            t.displayRainCover();
        });

        t.hourSpan = t.numbers[0];
        GDYB.GridProductClass.currentType = "prvn";
        GDYB.GridProductClass.currentVersion = "p";

        //初始化制作时间和预报时间
        var dateNow = new Date();
        if (GDYB.GridProductClass.currentMakeTime == null) {
            dateNow.setMinutes(0);
            dateNow.setSeconds(0);
        }
        else {
            var curTimeStr = GDYB.GridProductClass.currentMakeTime;
            var year = parseInt(curTimeStr.replace(/(\d*)-\d*-\d* \d*:\d*:\d*/, "$1"));
            var month = parseInt(curTimeStr.replace(/\d*-(\d*)-\d* \d*:\d*:\d*/, "$1"));
            var day = parseInt(curTimeStr.replace(/\d*-\d*-(\d*) \d*:\d*:\d*/, "$1"));
            var hour = parseInt(curTimeStr.replace(/\d*-\d*-\d* (\d*):\d*:\d*/, "$1"));
            var minutes = 0;
            var seconds = 0;
            dateNow.setFullYear(year, month - 1, day);
            dateNow.setHours(hour, minutes, seconds, 0);
        }
        if (dateNow.getHours() > 5 && dateNow.getHours() <= 16)
            $("#selectMakeTime").val(5);
        else
            $("#selectMakeTime").val(16);
        var makeTimeHour = $("#selectMakeTime").val();
        setForecastTime(dateNow, makeTimeHour);

        //根据制作时间，设置预报时间
        function setForecastTime(datetime, makeTimeHour) {
            if (typeof (datetime) == "undefined")
                datetime = t.myBarDateSelecter.getCurrentTimeReal();
            if (typeof (makeTimeHour) == "undefined")
                makeTimeHour = $("#selectMakeTime").val();
            if (GDYB.GridProductClass.currentType == "prvn") {
                if (makeTimeHour == 5)
                    datetime.setHours(8);
                else
                    datetime.setHours(20);
            }
            else if (GDYB.GridProductClass.currentType == "cty" || GDYB.GridProductClass.currentType == "cnty") {
                if (makeTimeHour == 5 || makeTimeHour == 10)
                    datetime.setHours(8);
                else
                    datetime.setHours(20);
            }
            t.myBarDateSelecter.setCurrentTime(datetime.format("yyyy-MM-dd hh:mm:ss"));

            datetime.setHours(makeTimeHour);
            GDYB.GridProductClass.currentMakeTime = datetime.format("yyyy-MM-dd hh:mm:ss");
            GDYB.GridProductClass.currentDateTime = t.myBarDateSelecter.getCurrentTime(false);
        }

        //测试数据
        $("#alarmMessageTable").html(`
            <ul style="text-decoration: none;">
                <li style="height: 95px;line-height: 20px;margin-top: 2px;">
                    <div flag="orange" style="height: 100%;width: 3%;background-color: orange;float: left;"></div>
                    <div style="height: 100%;width: 97%;padding: 6px 3px 0 6px;float: left;background-color: rgb(57,72,79);">
                        <p>黄河流域中小河流洪水橙色预报</p>
                        <p>黄河流域过去24小时雨量已达到60mm，预计未来24小时将有80mm，请注意做好预警发布。</p>
                        <p style="float: right;">10-06 07:45:00</p>
                    </div>
                </li>
                <li style="height: 95px;line-height: 20px;margin-top: 2px;">
                    <div flag="blue" style="height: 100%;width: 3%;background-color: blue;float: left;"></div>
                    <div style="height: 100%;width: 97%;padding: 6px 3px 0 6px;float: left;background-color: rgb(57,72,79);">
                        <p>黄河流域中小河流洪水蓝色预报</p>
                        <p>黄河流域过去24小时雨量已达到60mm，预计未来24小时将有80mm，请注意做好预警发布。</p>
                        <p style="float: right;">10-06 07:45:00</p>
                    </div>
                </li>
                <li style="height: 95px;line-height: 20px;margin-top: 2px;">
                    <div flag="yellow" style="height: 100%;width: 3%;background-color: yellow;float: left;"></div>
                    <div style="height: 100%;width: 97%;padding: 6px 3px 0 6px;float: left;background-color: rgb(57,72,79);">
                        <p>黄河流域中小河流洪水黄色预报</p>
                        <p>黄河流域过去24小时雨量已达到60mm，预计未来24小时将有80mm，请注意做好预警发布。</p>
                        <p style="float: right;">10-06 07:45:00</p>
                    </div>
                </li>
                <li style="height: 95px;line-height: 20px;margin-top: 2px;">
                    <div flag="red" style="height: 100%;width: 3%;background-color: red;float: left;"></div>
                    <div style="height: 100%;width: 97%;padding: 6px 3px 0 6px;float: left;background-color: rgb(57,72,79);">
                        <p>黄河流域中小河流洪水红色预报</p>
                        <p>黄河流域过去24小时雨量已达到60mm，预计未来24小时将有80mm，请注意做好预警发布。</p>
                        <p style="float: right;">10-06 07:45:00</p>
                    </div>
                </li>
            </ul>
        `);
        $("#product_shanhong_list").html(`
            <li>甘肃省山洪灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省山洪灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省山洪灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省山洪灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省山洪灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省山洪灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省山洪灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
        `);
        $("#product_dizhizaihai_list").html(`
            <li>甘肃省地质灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省地质灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省地质灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省地质灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省地质灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省地质灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省地质灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
        `);
        $("#product_hongshui_list").html(`
            <li>甘肃省河流灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省河流灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省河流灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省河流灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省河流灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省河流灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
            <li>甘肃省河流灾害气象风险预警第45期&nbsp;&nbsp;2017.10.17</li>
        `);
        $("#monitoringAlarmTable").html(`
            <div style="height: 100%">
                <table border="1" width="100%">
                    <tr>
                        <td width="6%" rowspan="2">区域名</td>   <td width="6%" rowspan="2">类型</td>   <td width="8%" rowspan="2">ID</td>   <td colspan="4">1级临界阀值</td>   <td colspan="4">2级临界阀值</td>   <td colspan="4">3级临界阀值</td>   <td colspan="4">4级临界阀值</td>
                    </tr>
                    <tr>
                        <td width="5%">1h</td>   <td width="5%">3h</td>   <td width="5%">6h</td>   <td width="5%">24h</td>
                        <td width="5%">1h</td>   <td width="5%">3h</td>   <td width="5%">6h</td>   <td width="5%">24h</td>
                        <td width="5%">1h</td>   <td width="5%">3h</td>   <td width="5%">6h</td>   <td width="5%">24h</td>
                        <td width="5%">1h</td>   <td width="5%">3h</td>   <td width="5%">6h</td>   <td width="5%">24h</td>
                    </tr>
                    <tr>
                        <td>榆树湾</td>    <td>滑坡</td>     <td>360105010115</td>   <td>8</td>   <td>13</td>   <td>25</td>   <td>70</td>   <td>5</td>   <td>10</td>   <td>20</td>   <td>60</td>   <td>3</td>   <td>8</td>   <td>15</td>   <td>30</td>   <td>2</td>   <td>5</td>   <td>10</td>   <td>20</td>
                    </tr>
                    <tr>
                        <td>榆树湾</td>    <td>滑坡</td>     <td>360105010115</td>   <td>8</td>   <td>13</td>   <td>25</td>   <td>70</td>   <td>5</td>   <td>10</td>   <td>20</td>   <td>60</td>   <td>3</td>   <td>8</td>   <td>15</td>   <td>30</td>   <td>2</td>   <td>5</td>   <td>10</td>   <td>20</td>
                    </tr>
                    <tr>
                        <td>榆树湾</td>    <td>滑坡</td>     <td>360105010115</td>   <td>8</td>   <td>13</td>   <td>25</td>   <td>70</td>   <td>5</td>   <td>10</td>   <td>20</td>   <td>60</td>   <td>3</td>   <td>8</td>   <td>15</td>   <td>30</td>   <td>2</td>   <td>5</td>   <td>10</td>   <td>20</td>
                    </tr>
                    <tr>
                        <td>榆树湾</td>    <td>滑坡</td>     <td>360105010115</td>   <td>8</td>   <td>13</td>   <td>25</td>   <td>70</td>   <td>5</td>   <td>10</td>   <td>20</td>   <td>60</td>   <td>3</td>   <td>8</td>   <td>15</td>   <td>30</td>   <td>2</td>   <td>5</td>   <td>10</td>   <td>20</td>
                    </tr>
                    <tr>
                        <td>榆树湾</td>    <td>滑坡</td>     <td>360105010115</td>   <td>8</td>   <td>13</td>   <td>25</td>   <td>70</td>   <td>5</td>   <td>10</td>   <td>20</td>   <td>60</td>   <td>3</td>   <td>8</td>   <td>15</td>   <td>30</td>   <td>2</td>   <td>5</td>   <td>10</td>   <td>20</td>
                    </tr>
                    <tr>
                        <td>榆树湾</td>    <td>滑坡</td>     <td>360105010115</td>   <td>8</td>   <td>13</td>   <td>25</td>   <td>70</td>   <td>5</td>   <td>10</td>   <td>20</td>   <td>60</td>   <td>3</td>   <td>8</td>   <td>15</td>   <td>30</td>   <td>2</td>   <td>5</td>   <td>10</td>   <td>20</td>
                    </tr>
                </table>
            </div>
        `);
        /*end*/

        var userName = GDYB.GridProductClass.currentUserName;
        if (userName == null) {
            alertModal("请注意，您尚未登录！");
        }
        else {
            var param = '{"userName":' + userName + '}';
            $.ajax({
                type: 'post',
                url: userServiceUrl + "services/UserService/getIssuer",
                data: { 'para': param },
                dataType: 'text',
                error: function () {
                    alertModal('获取签发人错误!');
                },
                success: function (data) {
                    if (data == "[]") {
                        alertModal("未查询到签发人");
                    }
                    else {
                        var issuers = jQuery.parseJSON(data);
                        for (var key in issuers) {
                            var issuer = issuers[key];
                            $("#selectQianFaRen").append("<div>" + issuer.name + "</div>");
                        }
                        $("#selectQianFaRen").find("div").click(function () {
                            $("#issueor").find("input").val($(this).html());
                            $("#selectQianFaRen").find("div").css("background-color", "");
                            $("#selectQianFaRen").find("div").css("color", "");
                            $(this).css("background-color", "rgb(116,173,213)").css("color", "#ffffff");
                        });
                        $("#issueor").find("input").val($("#selectQianFaRen").find("div").eq(0).html());
                        $("#selectQianFaRen").find("div").eq(0).css("background-color", "rgb(116,173,213)").css("color", "#ffffff");
                    }
                }
            });
        }

        //切换菜单
        $(".menu_changeDiv").find(".menu_change").click(function () {
            if ($(this).hasClass("active"))
                return;
            $(".menu_changeDiv").find(".active").removeClass("active");
            $(this).addClass("active");
            if ($(this).attr("name") == "jcbj") {
                $("#monitoringAlarmDiv").css("display", "block");
                $("#makeAlarmDiv").css("display", "none");
                $("#queryAlarmDiv").css("display", "none");
            }
            else if ($(this).attr("name") == "yjzz") {
                $("#monitoringAlarmDiv").css("display", "none");
                $("#makeAlarmDiv").css("display", "block");
                $("#queryAlarmDiv").css("display", "none");
            }
            else if ($(this).attr("name") == "cpcx") {
                $("#monitoringAlarmDiv").css("display", "none");
                $("#makeAlarmDiv").css("display", "none");
                $("#queryAlarmDiv").css("display", "block");
            } else { }
        });

        //预警制作按钮事件
        $("#alarmFormButton button").click(function () {
            var btnId = $(this).attr("id");
            if (btnId == "make_alarm") {

            }
            else if (btnId == "make_product") {
                $("#alarmProductListDiv").css("display", "block");
                confirmModal("确认生成产品？",t.creatAlarmWord);
            }
            else if (btnId == "make_uploadProduct") {

            }
            else { }
        });
        $("#dropZoneCorrection .dropZoneLevel").click(function () {
            var dropLevel = $(this).attr("value");
            var level = parseInt(dropLevel);
            t.updateLevel(level);
        });
        // $("#dropZoneCorrection #dropZoneType").find("button").click(function(){
        //     $("#dropZoneCorrection #dropZoneType button").removeClass("active");
        //     $(this).addClass("active");
        //     var dropType = $(this).attr("id");

        //});

        //预警制作栏产品展示
        $("#alarmProductListDiv .productList").click(function () {
            $("#alarmProductListWindow").css("display", "block");
            if ($(this).attr("id") == "list_word") {
                $("#productWindowTitle").html("文档");
                $("#alarmProductListWindow #productShow").html(`
                    <img style="width: 75%;height: 90%;margin: 0px auto;display: block;" src="imgs/demo01.png"/>
                `);
            }
            else if ($(this).attr("id") == "list_jpg") {
                $("#productWindowTitle").html("图像");
                $("#alarmProductListWindow #productShow").html(`
                    <img style="width: 75%;height: 90%;margin: 0px auto;display: block;" src="imgs/demo02.png"/>
                `);
            }
            else if ($(this).attr("id") == "list_txt") {
                $("#productWindowTitle").html("文本");
                $("#alarmProductListWindow #productShow").html(`
                    <img style="width: 75%;height: 90%;margin: 0px auto;display: block;" src="imgs/demo03.png"/>
                `);
            }
            else { }
        });
        $("#alarmProductListWindow .closeProductWindow").click(function () {
            $("#alarmProductListWindow").css("display", "none");
        });

        //产品查询栏产品展示
        $(".productContent li").click(function () {
            $("#queryAlarmShowDiv").css("display", "block");
            $("#queryAlarm_product").html(`
                <img style="width:20px;margin: 0 15px 0 15px;" src="imgs/icon_word.png"/><span style="font-family: 楷体;">甘肃省地质灾害气象风险预警第45期.docx</span>
                <img style="width: 75%;height: 90%;margin: 0px auto;display: block;" src="imgs/demo01.png"/>
            `);
        });
        $("#queryAlarmShowDiv").click(function () {
            $(this).css("display", "none");
        });

        //按钮事件
        $("#alarmStrategy").find("button").click(function () {
            $("#alarmStrategy").find("button").removeClass("active");
            $(this).addClass("active");
            var type = $(this).attr("id");
            if (type == "strategy_live") {

            }
            else if (type == "strategy_liveAndForecast") {

            }
            else if (type == "strategy_forecast") {

            }
            else { }
        });
        $("#riskType").find("button").click(function () {
            if ($(this).hasClass("active"))
                $(this).removeClass("active");
            else
                $(this).addClass("active");
        });

        //面雨量时间轴点击事件
        var isClick = false;
        $("#timeChooseBar").find("li").hover(function () {
            isClick = false;
            var tt = this;
            var f = parseInt($(tt).attr("flag"));
            $("#timeChooseBar li").each(function () {
                var f1 = parseInt($(this).attr("flag"));
                if (f > 0 && f1 > 0 && f1 <= f) {
                    $(this).css({ "background-color": "rgb(32,161,255)", "color": "#eee" });
                }
                if (f < 0 && f1 < 0 && f1 >= f) {
                    $(this).css({ "background-color": "rgb(32,161,255)", "color": "#eee" });
                }
            });
        }, function () {
            if (isClick)
                return;
            $("#timeChooseBar li").each(function () {
                $(this).css({ "background-color": "", "color": "" });
            });
        });
        $("#timeChooseBar").find("li").click(function () {
            $("#timeChooseBar li").css({ "background-color": "", "color": "" });
            isClick = true;
            var tt = this;
            var f = parseInt($(tt).attr("flag"));
            $("#timeChooseBar li").each(function () {
                var f1 = parseInt($(this).attr("flag"));
                if (f > 0 && f1 > 0 && f1 <= f) {
                    $(this).css({ "background-color": "rgb(32,161,255)", "color": "#eee" });
                }
                if (f < 0 && f1 < 0 && f1 >= f) {
                    $(this).css({ "background-color": "rgb(32,161,255)", "color": "#eee" });
                }
            });
            $("#monitoringAlarmTableDiv").css("display", "block");
            $("#riskLevelLegend").css("display", "none");
            t.displayRainCover();
        });
        $("#displayTableDiv").click(function () {
            $("#monitoringAlarmTableDiv").css("display", "none");
            $("#riskLevelLegend").css("display", "block");
        });
        await initRes();//先初始化资源
        event();//再初始化事件
        t.getAlertMsg();
        function event() {
            t.getShpInfo("中小河流");
            $("#bottomMenu input").change(function (item) {
                var ischecked = $(this).prop("checked");
                var type = $(this).attr("flag");
                if (ischecked) {
                    t.getShpInfo(type);
                }
                else {
                    var lmu = new LayerManagerUtil();
                    var layer = lmu.getLayer(type);
                    layer.removeAllFeatures();
                }
            });
            $("#areaEdit").on("click", function () {
                if ($(this).hasClass("active")) {
                    t.drawPolygon.deactivate()
                    $(this).removeClass("active");
                    startDragMap();
                }
                else {
                    t.drawPolygon.activate()
                    $(this).addClass("active");
                    stopDragMap();
                }

            });
        }
        /**
        * @author:wangkun
        * @date:2017-10-19
        * @param:
        * @return:
        * @description:初始化资源
        */
        async function initRes() {
            await t.getAllCounty();
            var lmu = new LayerManagerUtil();
            //初始化基础图层
            t.disasterLayer = lmu.addLayer("地质灾害隐患点", "vector");
            t.shLayer = lmu.addLayer("山洪沟", "vector");
            t.riverLayer = lmu.addLayer("中小河流", "vector");
            //画图图层
            var lmu = new LayerManagerUtil();
            var layer = lmu.addLayer("画图图层", "vector");
            layer.style = {
                fill: false,
                stroke: false
            };
            t.drawPolygon = new WeatherMap.Control.DrawFeature(layer, WeatherMap.Handler.PolygonFree);
            t.drawPolygon.events.on({ "featureadded": t.drawCompeleted });
            GDYB.Page.curPage.map.addControl(t.drawPolygon);
        }
    },
    /**
     * @author:dinlerkey
     * @date:2017-10-18
     * @param:
     * @return:
     * @description:面雨量显示
     */
    this.displayRainCover = function () {
        var type = GDYB.GridProductClass.currentType;
        var element = "r3";
        var elementName = "降水量";
        var maketime = GDYB.GridProductClass.currentMakeTime;
        var version = GDYB.GridProductClass.currentVersion;
        var datetime = t.myBarDateSelecter.getCurrentTime(false);
        var hourspan = t.hourSpan;
        var fromModel;
        var level = 1000;
        if (type == null || element == null || hourspan == null)
            return;

        //获取上一次时效
        var i = 0;
        var hourspans = GDYB.GDYBPage.getHourSpan(element);
        for (i; i < hourspans.length; i++) {
            if (hourspans[i] == hourspan)
                break;
        }
        var hourspanLast = 0;
        if (i > 0)
            hourspanLast = hourspans[i - 1];

        if (GDYB.GridProductClass.datasetGridInfos == null && GDYB.GridProductClass.datasetGridInfos.length > 0)
            GDYB.GridProductClass.getGridInfo(null, type, element, datetime);
        GDYB.GridProductClass.displayGridProduct(function () { }, type, level, element, maketime, version, datetime, hourspan, fromModel, elementName, hourspanLast);
    },
    /**
    * @author:wangkun
    * @date:2017-10-18
    * @param:
    * @return:
    * @description:获取预警消息
    */
    this.getAlertMsg = function () {
        var date = new Date();
        var strDatetime = date.format("yyyy-MM-dd hh:00:00");
        var type = "山洪沟";
        var param = {
            types: type,
            datetime: strDatetime
        };
        param = JSON.stringify(param);
        var url = flashFloodServiceUrl + "ProductService/getLastFlashFloodByType";
        AJAX(url, param, function () {

        }, function (data) {
            t.displayRiskAlert(type, data);
        });
    },
    /**
     * @author:wangkun
     * @date:2017-10-19
     * @param:
     * @return:
     * @description:获取shp文件信息
     */
    this.getShpInfo = function (type) {
        var param = {
            type: type
        };
        param = JSON.stringify(param);
        var url = flashFloodServiceUrl + "ProductService/getShpByType";
        AJAX(url, param, function () {
        }, function (data) {
            t.displayShp(data, type);
        });
    },
    /**
     * @author:wangkun
     * @date:2017-10-19
     * @param:
     * @return:
     * @description:显示shp数据
     */
    this.displayShp = function (data, name) {
        var lmu = new LayerManagerUtil();
        var layer = lmu.addLayer(name, "vector");
        layer.removeAllFeatures();
        var vectors = [];
        data.features.forEach(item => {
            var geo = item.geometry;
            var datatype = geo.type;
            if (datatype === "REGION") {
                var style = {
                    fillColor: "#9BE1FF",
                    strokeWidth: 2,
                    fillOpacity: 0.6,
                    strokeColor: "#9BE1FF"
                };
                var pointArray = [];
                geo.points.forEach(itemP => {
                    var point = new WeatherMap.Geometry.Point(itemP.x, itemP.y);
                    pointArray.push(point);
                });
                var linearRings = new WeatherMap.Geometry.LinearRing(pointArray);
                var vector = new WeatherMap.Feature.Vector(linearRings, null, style);
                vectors.push(vector);
            }
            else if (datatype === "POINT") {
                var style = {
                    strokeColor: color,
                    strokeOpacity: 1,
                    strokeWidth: 1,
                    pointRadius: 3
                };
                var pt = geo.points[0];
                var geoPT = new WeatherMap.Geometry.Point(pt.x, pt.y);
                var vector = new WeatherMap.Feature.Vector(geoPT, null, style);
                vectors.push(vector);
            }
        });
        layer.addFeatures(vectors);
    },
    /**
     * @author:wangkun
     * @date:2017-10-19
     * @param:
     * @return:
     * @description:显示风险区域
     */
    this.displayRiskAlert = function (name, data) {
        var lmu = new LayerManagerUtil();
        var layer = lmu.addLayer(name + "Alert", "vector");
        layer.removeAllFeatures();

        var obj = JSON.parse(data);
        var vectors = [];
        obj.features.forEach(item => {
            var level = item.fieldValues[1];
            var name = item.fieldValues[2];
            level = parseInt(level);
            var color = t.levelColor[level - 1];
            var geo = item.geometry;
            var dataType = geo.type;
            if (dataType === "REGION") {
                var style = {
                    fillColor: color,
                    fillOpacity: 0.8,
                    stroke: false
                };
                var pointArray = [];
                geo.points.forEach(itemP => {
                    var point = new WeatherMap.Geometry.Point(itemP.x, itemP.y);
                    pointArray.push(point);
                });
                var linearRings = new WeatherMap.Geometry.LinearRing(pointArray);
                var vector = new WeatherMap.Feature.Vector(linearRings, null, style);
                vector.level = level;
                vector.name = name;
                vectors.push(vector);
            }
            else if (dataType === "POINT") {
                var style = {
                    strokeColor: color,
                    strokeOpacity: 1,
                    strokeWidth: 1,
                    pointRadius: 3
                };
                var pt = geo.points[0];
                var geoPT = new WeatherMap.Geometry.Point(pt.x, pt.y);
                var vector = new WeatherMap.Feature.Vector(geoPT, null, style);
                vector.level = level;
                vector.name = name;
                vectors.push(vector);
            }
        });
        layer.addFeatures(vectors);
        setTimeout(t.inversionText, 10);
    },
    /**
     * @author:wangkun
     * @date:2017-10-19
     * @param:
     * @return:
     * @description:绘制完成
     */
    this.drawCompeleted = function (event) {
        var lmu = new LayerManagerUtil();
        var alertLayer = lmu.getLayer("山洪沟Alert");
        if (alertLayer == null) {
            console.log("预警图层为空!");
            return;
        }
        var feature = event.feature;
        var drawGeo = feature.geometry;
        //获取预警图层中的所有对象,暂时用shLayer
        var allFeature = alertLayer.features;
        allFeature.forEach(item => {
            var thisGeo = item.geometry;
            //1、不相交的
            var dis = thisGeo.distanceTo(drawGeo, {
                details: false,
                edge: true
            });
            if (dis != 0) {
                //2、计算中心中是否被包含
                var isContain = drawGeo.containsPoint(thisGeo.getCentroid());
                if (!isContain) {
                    item.style.stroke = false;
                    item.selected = false;
                    return;
                }
            }
            item.style.stroke = true;
            item.style.strokeColor = "green";
            item.style.strokeWidth = 4;
            item.selected = true;
        });
        alertLayer.redraw();
    },
    /**
     * @author:wangkun
     * @date:2017-10-19
     * @param:
     * @return:
     * @description:更新等级
     */
    this.updateLevel = function (level) {
        var lmu = new LayerManagerUtil();
        var alertLayer = lmu.getLayer("山洪沟Alert");
        if (alertLayer == null) {
            console.log("预警图层为空!");
            return;
        }
        var allFeature = alertLayer.features;
        allFeature.forEach(item => {
            if (item.selected) {
                item.style.fillColor = t.levelColor[level - 1];
                item.level = level;
            }
            //item.style.stroke = false;
        });
        alertLayer.redraw();
        setTimeout(t.inversionText, 10);
    },
    /**
     * @author:dinlerkey
     * @date:2017-10-19
     * @param:
     * @return:
     * @description:生成word
     */
    this.creatAlarmWord = function(){
        var titleDate = t.myDateSelecter.getCurrentTime(false).replace(/-/g,"").replace(/\s/g,"").replace(/:/g,"").substr(0,12);
        var productName = "MSP3_GS-MO_MDRWTFLD_FLAFLOOD_L88_GS_"+ titleDate +"_00000-00600";
        var title = $("#alarmType").val();
        var year = t.myDateSelecter.getCurrentTime(false).substr(0,4);
        var issue = $("#alarmIssue").val();
        var signer = $("#alarmSigner").val();
        var maker = $("#alarmForecastor").val();
        var dateTime = t.myDateSelecter.getCurrentTime(true).replace(/\s/g,"").substr(0,14);
        var alarmContent = title.replace("气象风险预警","") + t.mostAlarmLevel;
        var txtContent = $("#browseText").text();
        var imgElement = document.getElementById("productImg");
        var data = t.getBase64Image(imgElement);
        var img = data.replace("data:image/png;base64,","");
        var archiveService = "http://172.23.2.237"+":8080/SPDArchiveService/";
        var url = archiveService + "services/ArchiveService/createProduct";
        $.ajax({
            data: {"para": "{templateName:'alarm.ftl',productName:'" + productName + ".doc',title:'"+ title +"',year:'"+ year +"',issue:'"+ issue +"',signer:'"+ signer +"',maker:'"+ maker +"',dateTime:'"+ dateTime +"',alarmContent:'"+ alarmContent +"',txtContent:'"+ txtContent +"',img:'"+ img +"'}"},
            url: url,
            dataType: "json",
            success: function (data) {
                if(data){
                    alert("生成产品成功");
                    //wordDownload();//下载到本地
                }
                else
                    alert("生成产品失败");
            },
            error:function(data){
            },
            type: "POST"
        });
    },
    //图片转码
    this.getBase64Image = function(img) {
        var canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;

        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, img.width, img.height);

        var dataURL = canvas.toDataURL("image/png");
        return dataURL;
        // return dataURL.replace("data:image/png;base64,", "");
    },
    /**
     * @author:wangkun
     * @date:2017-10-19
     * @param:
     * @return:
     * @description:反常文字
     */
    this.inversionText = function () {
        //预警区域
        var lmu = new LayerManagerUtil();
        var alertLayer = lmu.getLayer("山洪沟Alert");
        if (alertLayer == null) {
            console.log("预警图层为空!");
            return;
        }
        var allFeature = alertLayer.features;
        var riskMsg = "&emsp;&emsp;";
        //获取所有交叉区县
        var strCountys = "";
        allFeature.forEach(item => {
            var geo = item.geometry;
            t.allCounty.forEach(countryGeo => {
                var dis = geo.distanceTo(countryGeo, {
                    details: false,
                    edge: true
                });
                if (dis == 0) {
                    console.log(countryGeo.name);
                    strCountys+=countryGeo.name;
                    strCountys+=",";
                }
            });
        });
        strCountys = strCountys.substring(0,strCountys.length-1);
        strCountys+="最大降水面雨量达到XXXmm。";
        riskMsg+=strCountys;
        
        for (var i = 1; i <= 4; i++) {
            var thisFeatures = allFeature.filter(item => {
                return item.level == i;
            });
            var levelT = t.levelTxt[i - 1];
            var tempTxt = "";
            thisFeatures.forEach(item => {
                var name = item.name;
                tempTxt += name;
                tempTxt += "、";
            });
            if (tempTxt.length < 1) {
                continue;
            }
            tempTxt = tempTxt.substring(0, tempTxt.length - 1);
            if (tempTxt.length > 0) {
                tempTxt += levelT;
            }
            tempTxt += ";";
            riskMsg += tempTxt;
        }
        riskMsg = riskMsg.substring(0,riskMsg.length-1);
        riskMsg += "。";
        $("#browseText").html(riskMsg);
    },
    /**
     * @author:wangkun
     * @date:2017-10-19
     * @param:
     * @return:
     * @description:获取所有区县
     */
    this.getAllCounty = async function () {
        var url = flashFloodServiceUrl + "AdminDivisionService/getCounty";
        var pro = new Promise(function (resolve, reject) {
            AJAX(url, "", function(){
                resolve("err");
            }, function(data){
                //转对象
                data.forEach(item=>{
                    var obj = JSON.parse(item);
                    var name = obj.fieldValues[0];
                    var pointArray = [];
                    obj.geometry.points.forEach(itemP => {
                        var point = new WeatherMap.Geometry.Point(itemP.x, itemP.y);
                        pointArray.push(point);
                    });
                    var linearRings = new WeatherMap.Geometry.LinearRing(pointArray);
                    var thisRegion = new WeatherMap.Geometry.Polygon([linearRings]);
                    thisRegion.name = name;
                    t.allCounty.push(thisRegion);
                });
                resolve(data);
            });
        });
        return pro;
    }
}
QDLQXFXPageClass.prototype = new PageBase();